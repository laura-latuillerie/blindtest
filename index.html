<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Blindtest Spotify â€” Color Pop</title>
  <meta name="description" content="Blindtest Spotify: 50 titres max. Mode preview 30s ou Lecteur Spotify Premium (Web Playback SDK). Synchronisation fiable + UI colorÃ©e minimaliste." />
  <style>
    /* ===== Palette inspirÃ©e de l'exemple (pastels) ===== */
    :root{
      --cream: #F6EEDD;
      --lime:  #D8FF66; /* jaune-vert */
      --pink:  #FF9BD4;
      --lilac: #C7C5FF;
      --aqua:  #BFF7FF;
      --ink:   #0E1321; /* texte foncÃ© */
      --muted: #5B6175;
      --ok:    #1DB954;
      --danger:#FF6B6B;
      --radius: 18px;
      --shadow: 0 12px 30px rgba(0,0,0,.12);
    }

    html, body { height:100%; }
    body{
      margin:0; color:var(--ink);
      background:
        radial-gradient(900px 600px at 10% -10%, var(--aqua) 0%, transparent 60%),
        radial-gradient(900px 600px at 110% 10%, var(--pink) 0%, transparent 60%),
        var(--cream);
      font: 16px/1.5 system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, sans-serif;
    }

    .container{ max-width:1000px; margin:0 auto; padding:24px; }

    header{ display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:12px; }
    .brand{ display:flex; align-items:center; gap:10px; font-weight:900; letter-spacing:.2px; }
    .brand .dot{ width:14px; height:14px; border-radius:50%; background: conic-gradient(from 180deg, var(--pink), var(--lilac), var(--lime)); box-shadow:0 0 0 4px rgba(255,255,255,.6); }

    /* ===== Cards & layout ===== */
    .card{ background:white; border-radius:var(--radius); box-shadow:var(--shadow); padding:18px; border:3px solid #00000010; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:16px; }
    @media (max-width: 900px){ .grid{ grid-template-columns: 1fr; } }

    /* ===== Inputs ===== */
    label{ display:block; font-size:.92rem; color:var(--ink); font-weight:700; margin-bottom:6px; }
    .help{ color:var(--muted); font-size:.85rem; }

    input[type="text"], input[type="url"], input[type="number"]{
      width:100%; padding:12px 14px; border-radius:14px; border:2px solid #00000015; outline:none; background:#fff; color:var(--ink);
    }
    input::placeholder{ color:#9aa1b2; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .row > * { flex: 1 1 auto; }

    /* Checkboxes: align & joli */
    .check{ display:flex; align-items:center; gap:10px; }
    .check input[type=checkbox]{
      appearance: none; width:20px; height:20px; border-radius:6px; border:2px solid #00000030; display:grid; place-items:center; background:white; cursor:pointer;
    }
    .check input[type=checkbox]::after{ content:"âœ”"; font-size:14px; transform:scale(0); transition:.12s; }
    .check input[type=checkbox]:checked{ background: var(--lime); border-color:#00000060; }
    .check input[type=checkbox]:checked::after{ transform:scale(1); }

    button{
      appearance:none; border:0; border-radius:14px; padding:12px 16px; font-weight:800; cursor:pointer;
      background:#111; color:white; box-shadow: var(--shadow); transition: transform .04s ease;
    }
    button:active{ transform:translateY(1px); }
    button.secondary{ background:#ffffff; color:#111; border:2px solid #00000020; }
    button.ghost{ background:transparent; color:#111; border:2px dashed #00000030; }
    button.success{ background: var(--ok); }
    button:disabled{ opacity:.5; cursor:not-allowed; }

    .pill{ display:inline-flex; align-items:center; gap:6px; padding:8px 10px; border-radius:999px; background: #ffffffd9; border:2px solid #00000010; font-weight:700; }

    /* Progress */
    .progress{ position:relative; height:14px; background:#fff; border:2px solid #00000020; border-radius:999px; overflow:hidden; }
    .progress .bar{ position:absolute; inset:0; width:0%; background: repeating-linear-gradient(90deg, var(--lilac), var(--lilac) 12px, var(--pink) 12px, var(--pink) 24px, var(--lime) 24px, var(--lime) 36px); transition: width .08s linear; }

    /* Stage */
    #stage{ margin-top:16px; }
    .stage-header{ display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    .screen{ display:grid; grid-template-columns: 240px 1fr; gap:20px; align-items:center; min-height: 280px; }
    @media (max-width: 760px){ .screen{ grid-template-columns:1fr; text-align:center; } }

    .cover{ width:100%; aspect-ratio:1; border-radius:22px; background:linear-gradient(135deg, var(--lilac), var(--aqua)); border:3px solid #00000010; overflow:hidden; display:grid; place-items:center; }
    .cover img{ width:100%; height:100%; object-fit:cover; display:block; }

    .title{ font-size: clamp(1.6rem, 2vw + 1rem, 2.4rem); font-weight:1000; letter-spacing:.2px; margin:4px 0; }
    .subtitle{ color:#313852; font-size:1rem; font-weight:700; }
    .meta{ margin-top:8px; color:#525b77; }

    .rules{ display:flex; flex-direction:column; gap:10px; background:white; border:2px dashed #00000025; border-radius:14px; padding:14px; }

    .controls{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .toast{ position:fixed; right:16px; bottom:16px; background:#111; color:#fff; padding:10px 12px; border-radius:12px; box-shadow:var(--shadow); }
    .hidden{ display:none !important; }

    /* Debug */
    details.debug{ margin-top:10px; }
    details.debug pre{ background:#fff; border:2px solid #00000010; border-radius:12px; padding:10px; max-height:200px; overflow:auto; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="brand"><span class="dot"></span> Blindtest <span style="font-weight:700;">Color Pop</span> âœ¨</div>
      <div id="authState" class="pill">ğŸ”’ Non connectÃ©</div>
    </header>

    <section id="setup" class="card" aria-label="Configuration">
      <div class="grid">
        <div>
          <label for="clientId">ğŸ†” Client ID Spotify (PKCE)</label>
          <input id="clientId" type="text" placeholder="ex: 1234567890abcdef1234567890abcd" autocomplete="off" />
          <div class="row" style="margin-top:10px">
            <button id="btnConnect" class="success">ğŸ”‘ Se connecter</button>
            <button id="btnDisconnect" class="ghost" title="Oublier le token">â™»ï¸ DÃ©connexion</button>
          </div>
          <p class="help">Ajoute <strong>lâ€™URL exacte</strong> de cette page dans les Redirect URIs de ton app Spotify. Le flux PKCE ne requiert pas de secret.</p>

          <div class="row" style="margin-top:12px; align-items:center">
            <label class="check"><input id="useSdk" type="checkbox" /> <span>ğŸ§ Utiliser le Lecteur Spotify (Premium)</span></label>
          </div>
          <div class="row" style="margin-top:8px; align-items:center">
            <button id="btnInitPlayer" class="secondary" disabled>ğŸ–¥ï¸ Activer le lecteur web</button>
            <button id="btnAudioUnlock" class="ghost" disabled>ğŸ–±ï¸ DÃ©bloquer lâ€™audio</button>
            <div id="playerState" class="pill">ğŸ›‘ Lecteur inactif</div>
            <label class="help" style="margin-left:8px;">ğŸ”Š</label>
            <input id="vol" type="range" min="0" max="1" step="0.01" value="1" disabled>
            <button id="btnReclaim" class="ghost" disabled>ğŸ›°ï¸ Reprendre le contrÃ´le</button>
          </div>
          <p class="help">Premium requis. Scopes: <code>streaming</code>, <code>user-modify-playback-state</code>, <code>user-read-playback-state</code>, <code>user-read-currently-playing</code>.</p>

          <details class="debug">
            <summary>ğŸ” Diagnostic lecteur</summary>
            <pre id="debug"></pre>
          </details>
        </div>
        <div>
          <label for="playlistUrl">ğŸ“œ Lien de playlist Spotify</label>
          <input id="playlistUrl" type="url" placeholder="https://open.spotify.com/playlist/â€¦ ou spotify:playlist:â€¦"/>
          <div class="row" style="margin-top:10px">
            <div>
              <label for="maxTracks"># Titres max</label>
              <input id="maxTracks" type="number" min="1" max="50" value="50" />
            </div>
            <label class="check"><input id="shuffle" type="checkbox" /> <span>ğŸ”€ MÃ©langer lâ€™ordre</span></label>
            <button id="btnLoad" class="secondary">ğŸ“¥ Charger la playlist</button>
          </div>
          <div id="playlistSummary" class="help" style="margin-top:10px"></div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button id="btnStart" class="success" disabled>â–¶ï¸ DÃ©marrer le blindtest</button>
      </div>
    </section>

    <section id="stage" class="card hidden" aria-live="polite">
      <div class="stage-header">
        <div class="pill" id="playlistName">ğŸ¶ Playlist</div>
        <div class="pill" id="counter">0 / 0</div>
      </div>
      <div class="progress" aria-label="Progression"><div class="bar" id="progressBar"></div></div>
      <div class="screen" id="screen" style="margin:16px 0 12px"></div>
      <div class="controls">
        <button id="btnSkip" class="secondary">â­ï¸ Suivant</button>
        <button id="btnRestart" class="ghost">ğŸ” Recommencer</button>
      </div>
      <audio id="player" preload="auto"></audio>
    </section>

    <div id="toast" class="toast hidden">Info</div>
  </div>

  <!-- SDK Spotify -->
  <script src="https://sdk.scdn.co/spotify-player.js"></script>

  <script>
  // ===== DurÃ©es & constantes =====
  const INTRO_MS = 10_000;  // intro
  const GUESS_MS = 10_000;  // phase devine
  const ANSWER_MS = 10_000; // phase rÃ©ponse (son continue)
  const FADE_OUT_MS = 2_000; // fondu sur la fin de rÃ©ponse
  const MAX_TOTAL = 50;

  const els = {
    authState: document.getElementById('authState'),
    clientId: document.getElementById('clientId'),
    connect: document.getElementById('btnConnect'),
    disconnect: document.getElementById('btnDisconnect'),
    useSdk: document.getElementById('useSdk'),
    btnInitPlayer: document.getElementById('btnInitPlayer'),
    btnAudioUnlock: document.getElementById('btnAudioUnlock'),
    btnReclaim: document.getElementById('btnReclaim'),
    playerState: document.getElementById('playerState'),
    vol: document.getElementById('vol'),
    playlistUrl: document.getElementById('playlistUrl'),
    maxTracks: document.getElementById('maxTracks'),
    shuffle: document.getElementById('shuffle'),
    btnLoad: document.getElementById('btnLoad'),
    btnStart: document.getElementById('btnStart'),
    stage: document.getElementById('stage'),
    screen: document.getElementById('screen'),
    counter: document.getElementById('counter'),
    playlistName: document.getElementById('playlistName'),
    player: document.getElementById('player'),
    progressBar: document.getElementById('progressBar'),
    btnSkip: document.getElementById('btnSkip'),
    btnRestart: document.getElementById('btnRestart'),
    toast: document.getElementById('toast'),
    setup: document.getElementById('setup'),
    playlistSummary: document.getElementById('playlistSummary'),
    debug: document.getElementById('debug')
  };

  const state = {
    access_token: null,
    refresh_token: null,
    token_expires_at: 0,
    client_id: null,
    redirect_uri: location.origin + location.pathname,
    playlist: null,
    tracks: [], // { title, artists, preview, cover, year, album, uri }
    i: 0,
    device_id: null, // SDK device
    sdkPlayer: null,
    usingSdk: false,
    audioUnlocked: false,
  };

  // ===== Utils =====
  const clamp=(n,min,max)=> Math.max(min, Math.min(max,n));
  const sleep=(ms)=> new Promise(r=>setTimeout(r,ms));
  const b64url = (buf)=> btoa(String.fromCharCode(...new Uint8Array(buf))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  const sha256 = async (str)=> crypto.subtle.digest('SHA-256', new TextEncoder().encode(str));
  const randStr=(len=64)=> Array.from(crypto.getRandomValues(new Uint8Array(len))).map(x=>('0'+(x%36).toString(36)).slice(-1)).join('');
  function toast(msg, ms=2800){ els.toast.textContent = msg; els.toast.classList.remove('hidden'); setTimeout(()=> els.toast.classList.add('hidden'), ms); }
  function setProgress(p){ els.progressBar.style.width = clamp(p*100,0,100)+"%"; }
  function escapeHTML(s){ return (s||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function parsePlaylistId(url){ if(!url) return null; const s=url.trim(); let m=s.match(/playlist\/([a-zA-Z0-9]+)(?:\?|$)/); if(m) return m[1]; m=s.match(/^spotify:playlist:([a-zA-Z0-9]+)$/); if(m) return m[1]; return null; }
  function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } }
  function placeholderCover(){ const svg = encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 600 600'><defs><linearGradient id='g' x1='0' x2='1' y1='0' y2='1'><stop stop-color='${getComputedStyle(document.documentElement).getPropertyValue('--pink').trim()}'/><stop offset='1' stop-color='${getComputedStyle(document.documentElement).getPropertyValue('--lime').trim()}'/></linearGradient></defs><rect width='600' height='600' fill='${getComputedStyle(document.documentElement).getPropertyValue('--cream').trim()}'/><circle cx='300' cy='300' r='240' fill='url(#g)' opacity='0.35'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-family='system-ui,Segoe UI,Roboto,Arial' font-size='280' fill='#0E1321'>?</text></svg>`); return `data:image/svg+xml;charset=utf-8,${svg}`; }

  // ===== Auth storage/UI =====
  function saveAuth(){ localStorage.setItem('spotify_auth', JSON.stringify({ access_token:state.access_token, refresh_token:state.refresh_token, token_expires_at:state.token_expires_at, client_id:state.client_id, redirect_uri:state.redirect_uri })); }
  function loadAuth(){ try{ const saved=JSON.parse(localStorage.getItem('spotify_auth')||'{}'); if(saved.client_id) els.clientId.value = saved.client_id; Object.assign(state, saved); updateAuthUI(); }catch(e){} }
  function updateAuthUI(){ const ok = !!state.access_token && Date.now() < (state.token_expires_at||0); els.authState.textContent = ok? 'âœ… ConnectÃ©' : 'ğŸ”’ Non connectÃ©'; els.useSdk.disabled = !ok; els.btnInitPlayer.disabled = !ok; els.btnAudioUnlock.disabled = false; }

  // ===== PKCE OAuth =====
  async function beginAuth(){
    const client_id = els.clientId.value.trim(); if(!client_id){ toast('Renseigne ton Client ID Spotify'); return; }
    state.client_id = client_id; saveAuth();
    const verifier = randStr(64); const challenge = b64url(await sha256(verifier)); sessionStorage.setItem('pkce_verifier', verifier);
    const scopeBase = ['playlist-read-private','playlist-read-collaborative'];
    const scopeSdk = ['streaming','user-modify-playback-state','user-read-playback-state','user-read-currently-playing','user-read-email','user-read-private'];
    const scopes = els.useSdk.checked ? scopeBase.concat(scopeSdk) : scopeBase;
    const params = new URLSearchParams({ response_type:'code', client_id, redirect_uri:state.redirect_uri, code_challenge_method:'S256', code_challenge:challenge, scope: scopes.join(' ') });
    location.assign(`https://accounts.spotify.com/authorize?${params.toString()}`);
  }

  async function finishAuth(){
    const params = new URLSearchParams(location.search); const code = params.get('code'); if(!code) return;
    history.replaceState({}, '', state.redirect_uri);
    const verifier = sessionStorage.getItem('pkce_verifier'); if(!verifier){ toast('Verifier PKCE manquant. Relance la connexion.'); return; }
    const body = new URLSearchParams({ grant_type:'authorization_code', code, redirect_uri: state.redirect_uri, client_id: state.client_id || els.clientId.value.trim(), code_verifier: verifier });
    const res = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
    if(!res.ok){ toast('Ã‰chec token. VÃ©rifie Client ID & Redirect URI.'); return; }
    const tok = await res.json(); state.access_token = tok.access_token; state.refresh_token = tok.refresh_token; state.token_expires_at = Date.now() + (tok.expires_in*1000 - 5000); saveAuth(); updateAuthUI(); toast('ConnectÃ© Ã  Spotify âœ…');
  }

  async function ensureToken(){ if(state.access_token && Date.now() < state.token_expires_at) return; if(!state.refresh_token) throw new Error('Pas de token. Connecte-toi.'); const body=new URLSearchParams({ grant_type:'refresh_token', refresh_token: state.refresh_token, client_id: state.client_id || els.clientId.value.trim() }); const res = await fetch('https://accounts.spotify.com/api/token',{ method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body }); if(!res.ok) throw new Error('Refresh token invalide'); const tok=await res.json(); state.access_token = tok.access_token; if(tok.refresh_token) state.refresh_token = tok.refresh_token; state.token_expires_at = Date.now() + (tok.expires_in*1000 - 5000); saveAuth(); updateAuthUI(); }

  // ===== Spotify API helpers =====
  async function spGet(url){ await ensureToken(); const r=await fetch(url,{ headers:{ Authorization:`Bearer ${state.access_token}` } }); if(!r.ok) throw new Error('Spotify API '+r.status); return r.json(); }
  async function spPut(url, body){ await ensureToken(); const r=await fetch(url,{ method:'PUT', headers:{ Authorization:`Bearer ${state.access_token}`, 'Content-Type':'application/json' }, body: body? JSON.stringify(body): undefined }); if(r.status===204) return {ok:true}; const txt = await r.text(); if(!r.ok) throw new Error('STATUS '+r.status+' '+txt); try{ return JSON.parse(txt); }catch{ return {ok:r.ok, body:txt}; } }

  // ===== Chargement playlist =====
  async function loadPlaylist(){
    try{
      els.btnLoad.disabled = true; state.usingSdk = !!els.useSdk.checked;
      const id = parsePlaylistId(els.playlistUrl.value); if(!id){ toast('URL de playlist invalide'); return; }
      const pl = await spGet(`https://api.spotify.com/v1/playlists/${id}?fields=name,images,external_urls.spotify`);
      state.playlist = { id, name: pl.name, images: pl.images||[], url: pl.external_urls?.spotify };
      els.playlistName.textContent = 'ğŸ¶ '+(pl.name || 'Playlist');

      const maxWant = clamp(parseInt(els.maxTracks.value||MAX_TOTAL,10)||MAX_TOTAL,1,MAX_TOTAL);
      let url = `https://api.spotify.com/v1/playlists/${id}/tracks?limit=100&market=from_token&fields=items(track(id,is_local,name,uri,preview_url,artists(name),album(name,images,release_date,release_date_precision))),next`;
      const acc = [];
      while(url && acc.length < maxWant){
        const data = await spGet(url);
        for(const it of data.items||[]){
          const t = it.track; if(!t || t.is_local) continue; // pas de local
          const year = (t.album?.release_date||'').slice(0,4) || '';
          if(!state.usingSdk && !t.preview_url) continue; // en mode preview, on exclut sans preview
          acc.push({ title: t.name, artists: (t.artists||[]).map(a=>a.name).join(', '), preview: t.preview_url, cover: (t.album?.images||[])[0]?.url || '', year, album: t.album?.name || '', uri: t.uri });
          if(acc.length >= maxWant) break;
        }
        url = (data.next && acc.length < maxWant) ? data.next : null;
      }

      if(els.shuffle.checked) shuffle(acc);
      state.tracks = acc; state.i = 0;

      const total = acc.length;
      const msg = state.usingSdk
        ? `<strong>${state.playlist.name}</strong> â€” ${total} titres prÃªts <em>(mode Premium)</em>.`
        : `<strong>${state.playlist.name}</strong> â€” ${total} extraits 30s prÃªts (titres sans preview exclus).`;
      els.playlistSummary.innerHTML = msg;
      els.btnStart.disabled = total === 0;
      toast(total ? `âœ… ${total} titre(s) prÃªts` : (state.usingSdk ? 'Aucun titre exploitable (Premium requis ?)' : 'Aucun extrait jouable (pas de preview). Essaie le mode Premium.'));
    }catch(e){ console.error(e); toast('Erreur lors du chargement de la playlist.'); }
    finally{ els.btnLoad.disabled = false; }
  }

  // ===== Web Playback SDK =====
  window.onSpotifyWebPlaybackSDKReady = () => { /* SDK script chargÃ© */ };

  async function initSdkPlayer(){
    try{
      if(!state.access_token){ toast('Connecte-toi Ã  Spotify d\'abord'); return; }
      if(state.sdkPlayer){ toast('Lecteur dÃ©jÃ  prÃªt'); return; }
      const player = new Spotify.Player({ name: 'Blindtest Web Player', getOAuthToken: cb => cb(state.access_token), volume: els.vol.valueAsNumber || 1 });
      state.sdkPlayer = player;

      player.addListener('ready', ({ device_id }) => { state.device_id = device_id; els.playerState.textContent = 'ğŸŸ¢ Lecteur prÃªt'; els.btnReclaim.disabled = false; els.vol.disabled = true; /* volume via setVolume */ });
      player.addListener('not_ready', ({ device_id }) => { if(state.device_id===device_id) state.device_id=null; els.playerState.textContent = 'ğŸŸ  Lecteur indisponible'; });
      player.addListener('initialization_error', ({ message }) => logDebug('init_error', message));
      player.addListener('authentication_error', ({ message }) => logDebug('auth_error', message));
      player.addListener('account_error', ({ message }) => logDebug('account_error', message));
      player.addListener('player_state_changed', (st) => logDebug('state', st));

      const ok = await player.connect();
      if(!ok){ toast('Impossible de connecter le lecteur'); return; }

      await transferToWebPlayer(true); // attendre device actif
      els.playerState.textContent = 'ğŸŸ¢ Lecteur actif'; toast('Lecteur web prÃªt âœ…');
    }catch(e){ console.error(e); toast('Erreur d\'initialisation du lecteur.'); }
  }

  function logDebug(label, data){ try{ const prev = els.debug.textContent; const line = `
[${new Date().toLocaleTimeString()}] ${label}: ${typeof data==='string'?data:JSON.stringify(data)}`; els.debug.textContent = (prev+line).slice(-4000); }catch{} }

  async function spGetJson(url){ const r = await fetch(url,{ headers:{ Authorization:`Bearer ${state.access_token}` } }); if(!r.ok) throw new Error('GET '+r.status); return r.json(); }

  async function transferToWebPlayer(waitActive=false){
    if(!state.device_id) return;
    await spPut('https://api.spotify.com/v1/me/player', { device_ids:[state.device_id], play:false });
    if(waitActive){
      for(let i=0;i<15;i++){
        try{ const d = await spGetJson('https://api.spotify.com/v1/me/player/devices'); const me = (d.devices||[]).find(x=>x.id===state.device_id); if(me && me.is_active) return true; }catch{}
        await sleep(300);
      }
      toast('âš ï¸ Device pas encore actif. Clique Â« Reprendre le contrÃ´le Â».');
    }
    return true;
  }

  async function waitForSdkPlaying(uri, timeoutMs=7000){
    return new Promise((resolve, reject)=>{
      const start = performance.now();
      function onState(s){ if(!s) return; const playing = !s.paused; const cur = s.track_window?.current_track?.uri; if(playing && cur && cur === uri){ cleanup(); resolve(); } if(performance.now() - start > timeoutMs){ cleanup(); reject(new Error('SDK_START_TIMEOUT')); } }
      function cleanup(){ try{ state.sdkPlayer.removeListener('player_state_changed', onState);}catch{} }
      try{ state.sdkPlayer.addListener('player_state_changed', onState);}catch{}
      setTimeout(()=>{ cleanup(); reject(new Error('SDK_START_TIMEOUT')); }, timeoutMs+800);
    });
  }

  async function playSdkTrack(uri){
    if(!state.device_id) throw new Error('NO_DEVICE');
    try{
      await spPut(`https://api.spotify.com/v1/me/player/play?device_id=${state.device_id}`, { uris:[uri], position_ms: 0 });
      await waitForSdkPlaying(uri);
    }catch(e){ const msg = String(e.message||''); if(msg.includes('STATUS 403')) throw new Error('PREMIUM_REQUIRED'); if(msg.includes('STATUS 404') || msg.includes('NO_DEVICE')) throw new Error('NO_ACTIVE_DEVICE'); throw e; }
  }
  async function pauseSdk(){ try{ await spPut(`https://api.spotify.com/v1/me/player/pause?device_id=${state.device_id}`); }catch(e){} }
  async function setSdkVolume(vol){ try{ if(state.sdkPlayer) await state.sdkPlayer.setVolume(clamp(vol,0,1)); }catch(e){} }

  // ===== Audio unlock (navigateur) =====
  els.btnAudioUnlock.addEventListener('click', ()=>{ const a=els.player; a.src=''; a.play().catch(()=>{}); state.audioUnlocked=true; toast('ğŸ”“ Audio dÃ©bloquÃ©'); });
  els.vol.addEventListener('input', ()=>{ if(state.sdkPlayer) setSdkVolume(els.vol.valueAsNumber); else els.player.volume = els.vol.valueAsNumber; });
  els.btnReclaim.addEventListener('click', ()=> transferToWebPlayer(true));

  // ===== Jeu =====
  function startGame(){ if(!state.tracks.length){ toast('Charge d\'abord une playlist'); return; } state.i=0; setProgress(0); els.setup.classList.add('hidden'); els.stage.classList.remove('hidden'); showIntro().then(()=> playCurrent()); }
  function updateCounter(){ const total=state.tracks.length; els.counter.textContent = `ğŸ¯ ${Math.min(state.i+1,total)} / ${total}`; }
  async function showIntro(){ renderIntro(); setProgress(0); await runPhase(INTRO_MS); }

  async function playCurrent(){
    if(state.i >= state.tracks.length) return finish();
    updateCounter(); const t = state.tracks[state.i]; renderGuess(t);

    if(state.usingSdk){
      try{
        await transferToWebPlayer(true);
        await playSdkTrack(t.uri); // attendre la lecture rÃ©elle
        await runPhase(GUESS_MS, p=>setProgress(p));
        renderAnswer(t);
        await fadeAndWaitSdk(ANSWER_MS);
        nextTrack();
      }catch(err){
        logDebug('sdk_error', err.message||String(err));
        if(t.preview){ toast('ğŸ§ Lecteur Premium KO â€” on bascule sur l\'extrait 30s.'); await fallbackPreviewFlow(t); }
        else { toast('âš ï¸ Lecture impossible sur le lecteur web'); await sleep(1000); nextTrack(); }
      }
    } else {
      await fallbackPreviewFlow(t);
    }
  }

  async function fadeAndWaitSdk(totalMs){ const endAt = performance.now() + totalMs; const vol0 = els.vol.valueAsNumber || 1; await new Promise((resolve)=>{ function tick(){ const now=performance.now(); const remain=endAt-now; setProgress(1 - remain/totalMs); if(remain <= FADE_OUT_MS){ const f = clamp(remain/FADE_OUT_MS,0,1); setSdkVolume(vol0*f); } if(remain>16){ requestAnimationFrame(tick);} else { resolve(); } } requestAnimationFrame(tick); }); await pauseSdk(); await setSdkVolume(vol0); }

  async function fallbackPreviewFlow(t){ await playPreviewAndWait(t.preview); await runPhase(GUESS_MS, p=>setProgress(p)); renderAnswer(t); await fadeAndWaitAudio(ANSWER_MS); nextTrack(); }

  function playPreviewAndWait(src){ return new Promise((resolve)=>{ const a=els.player; a.pause(); a.src=src; a.currentTime=0; a.volume=els.vol.valueAsNumber || 1; const onStart = ()=>{ a.removeEventListener('playing', onStart); resolve(); }; a.addEventListener('playing', onStart, { once:true }); const p = a.play(); if(p && p.catch){ p.catch(()=>{ toast('ğŸ–±ï¸ Clique Â« DÃ©bloquer lâ€™audio Â»'); resolve(); }); } setTimeout(()=> resolve(), 1500); }); }
  async function fadeAndWaitAudio(totalMs){ const a = els.player; const endAt = performance.now() + totalMs; const fadeStart = endAt - FADE_OUT_MS; const vol0=a.volume; await new Promise((resolve)=>{ function tick(){ const now=performance.now(); const remain=endAt-now; setProgress(1 - remain/totalMs); if(now>=fadeStart){ const f=clamp(1 - (now - fadeStart)/FADE_OUT_MS,0,1); a.volume = vol0*f; } if(remain>16){ requestAnimationFrame(tick);} else { resolve(); } } requestAnimationFrame(tick); }); a.pause(); a.currentTime=0; a.volume=vol0; a.src=''; }

  function nextTrack(){ stopAll(); state.i++; updateCounter(); if(state.i < state.tracks.length){ playCurrent(); } else { finish(); } }

  function finish(){ stopAll(); setProgress(1); els.screen.innerHTML = `<div class=\"cover\"><img alt=\"Playlist cover\" src=\"${state.playlist?.images?.[0]?.url||placeholderCover()}\"></div><div><div class=\"title\">ğŸ‰ Fin du blindtest</div><div class=\"subtitle\">${state.playlist?.name||'Playlist'} â€” ${state.tracks.length} titre(s)</div><div class=\"meta\" style=\"margin-top:12px\">Relance avec Â« Recommencer Â» ou choisis une autre playlist.</div></div>`; }

  function renderIntro(){ els.screen.innerHTML = `<div class=\"cover\"><img alt=\"Playlist cover\" src=\"${state.playlist?.images?.[0]?.url||placeholderCover()}\"></div><div><div class=\"subtitle\">ğŸš¦ PrÃªtÂ·e ?</div><div class=\"title\">${escapeHTML(state.playlist?.name||'Ta playlist')}</div><div class=\"rules\"><div>ğŸ•’ Intro 10s â€¢ Puis 10s d\'Ã©coute / 10s de rÃ©ponse par titre</div><div>ğŸ† 1 point par <strong>artiste</strong> + 1 point par <strong>titre</strong></div><div>ğŸµ Jusqu\'Ã  ${state.tracks.length} titre(s)</div></div></div>`; }
  function renderGuess(t){ els.screen.innerHTML = `<div class=\"cover\"><img alt=\"Cover masquÃ©e\" src=\"${placeholderCover()}\"></div><div><div class=\"subtitle\">Extrait ${state.i+1}/${state.tracks.length} â€” 10 secondes</div><div class=\"title\">â“â“â“</div><div class=\"meta\">Trouve l\'artiste et le titre</div></div>`; }
  function renderAnswer(t){ els.screen.innerHTML = `<div class=\"cover\"><img alt=\"Cover\" src=\"${t.cover||placeholderCover()}\"></div><div><div class=\"subtitle\">RÃ©ponse â€¢ ${t.year ? t.year+' â€¢ ' : ''}${t.album ? escapeHTML(t.album) : ''}</div><div class=\"title\">${escapeHTML(t.title)}</div><div class=\"meta\">${escapeHTML(t.artists)}</div><div class=\"meta\" style=\"margin-top:8px\">L\'extrait continue ~10s</div></div>`; }

  // ===== Phases & controls =====
  function runPhase(ms, onProgress){ const start=performance.now(); return new Promise(res=>{ function step(){ const p=clamp((performance.now()-start)/ms,0,1); if(onProgress) onProgress(p); if(p<1){ requestAnimationFrame(step);} else {res();} } requestAnimationFrame(step); }); }
  function stopAll(){ try{ els.player.pause(); els.player.currentTime=0; els.player.src=''; }catch{} if(state.sdkPlayer){ pauseSdk(); } }

  // ===== Ã‰vÃ©nements UI =====
  els.connect.addEventListener('click', beginAuth);
  els.disconnect.addEventListener('click', ()=>{ state.access_token=null; state.refresh_token=null; state.token_expires_at=0; saveAuth(); updateAuthUI(); toast('Jeton supprimÃ©'); });
  els.btnLoad.addEventListener('click', loadPlaylist);
  els.btnStart.addEventListener('click', startGame);
  els.btnSkip.addEventListener('click', nextTrack);
  els.btnRestart.addEventListener('click', ()=>{ stopAll(); els.setup.classList.remove('hidden'); els.stage.classList.add('hidden'); setProgress(0); });
  els.useSdk.addEventListener('change', ()=>{ if(els.useSdk.checked){ toast('Mode Premium activÃ© â€” pense Ã  Â« Activer le lecteur web Â»'); } });
  els.btnInitPlayer.addEventListener('click', initSdkPlayer);

  // ===== Init =====
  (async function init(){ loadAuth(); await finishAuth(); updateAuthUI(); })();
  </script>
</body>
</html>
